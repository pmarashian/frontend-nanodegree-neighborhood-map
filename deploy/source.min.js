/*! frontend-nanodegree-neighborhood-map 2015-11-06 */
"use strict";function initApp(){ko.applyBindings(new ViewModel)}function inSearchFilter(a,b){return _.isUndefined(a)||_.isUndefined(b)?!1:a.toLowerCase().indexOf(b.toLowerCase())>-1}var map,activeMarker,infoWindowTemplate=_.template($("#infoWindowContent-template").html()),SMALL_SCREEN_MAX_WIDTH=420,WIDTH_FACTOR_INFO_WINDOW_MOBILE_PORTRAIT=.7,WIDTH_FACTOR_INFO_WINDOW_OTHER=1,iconCategories=[{names:["Restaurant","Pizza"],prop:{icon:fontawesome.markers.CUTLERY,fillColor:"#f8ae5f"}},{names:["Coffee"],prop:{icon:fontawesome.markers.COFFEE,fillColor:"#f8ae5f"}}],infoWindowContent=function(a){return infoWindowTemplate({title:a.title(),display_phone:a.display_phone(),description:a.description(),image:a.img(),address:a.location().display_address.join("<br>")})},Listing=function(a){this.id=ko.observable(a.id),this.title=ko.observable(a.title),this.img=ko.observable(a.img),this.description=ko.observable(a.description),this.location=ko.observable(a.location),this.phone=ko.observable(a.phone),this.display_phone=ko.observable(a.display_phone),this.categories=ko.observableArray(a.categories),this.show=ko.observable(!0),this.marker=new Marker(this),this.toggle=function(a){this.show(a),this.marker.toggle(a)}},Marker=function(a){var b,c,d=this,e=a.location().latitude,f=a.location().longitude,g=a.title(),a=a,h=window.screen.width<SMALL_SCREEN_MAX_WIDTH?WIDTH_FACTOR_INFO_WINDOW_MOBILE_PORTRAIT:WIDTH_FACTOR_INFO_WINDOW_OTHER;this.closeWindow=function(){c.close(),b.setAnimation(null),activeMarker=null},this.openWindow=function(){activeMarker&&activeMarker.closeWindow(),map.panTo(new google.maps.LatLng(e,f)),b.setAnimation(google.maps.Animation.BOUNCE),c.open(map,b),""==a.img()&&($(".image-col").removeClass("col-sm-2"),$(".content-col").addClass("col-sm-12").removeClass("col-sm-10")),activeMarker=d},this.toggle=function(a){b.setVisible(a),a||this.closeWindow()},this.getIcon=function(){var b={path:fontawesome.markers.MAP_MARKER,scale:.5,strokeWeight:.2,strokeColor:"black",strokeOpacity:1,fillColor:"#ff0000",fillOpacity:.9};return _.each(a.categories(),function(a){_.each(iconCategories,function(c){_.each(c.names,function(d){inSearchFilter(a,d)&&(b.path=c.prop.icon,b.fillColor=c.prop.fillColor)})})}),b},b=new google.maps.Marker({map:map,position:new google.maps.LatLng(e,f),title:g,animation:google.maps.Animation.DROP,icon:d.getIcon()}),c=new google.maps.InfoWindow({content:infoWindowContent(a),maxWidth:Math.floor(window.screen.width*h)}),google.maps.event.addListener(c,"closeclick",function(){b.setAnimation(null),activeMarker=null}),google.maps.event.addListener(b,"click",function(){d.openWindow()})},ViewModel=function(){var a=this;this.listings=ko.observableArray([]),this.activeListing=ko.observable(),this.filter=ko.observable(""),this.neighborhood=ko.observable("West San Jose"),this.loading=ko.observable(!1),this.searchPlaceholder=ko.computed(function(){return"Search within "+this.neighborhood()},this);var b=$(window),c=$("#map"),d=$(".search-bar"),e=$(".list-view"),f=$("#list-group-wrapper"),g=$("a.list-group-item.active")[0],h=!1;this.init=function(){this.setSizes(),a.initMap(),this.loadSavedData()||a.refresh().then(function(b){a.centerMap(b.region)}),this.initAutoComplete(),window.addEventListener("resize",function(){a.setSizes()}),window.addEventListener("orientationchange",function(){a.setSizes()},!1)},this.initAutoComplete=function(){var b=$("#search");b.typeahead({source:a.listings(),matcher:function(a){return inSearchFilter(a.title(),this.query)},displayText:function(a){return a.title()}}).change(function(){var c=b.typeahead("getActive");c&&c.title()==b.val()&&(a.centerMap(c.location().latitude,c.location().longitude),c.marker.openWindow())})},this.centerMap=function(a,b){map.setCenter({lat:a,lng:b}),map.setZoom(15)},this.refresh=function(){var b=Q.defer();return a.loading(!0),_.each(a.listings(),function(a){a.marker.toggle(!1)}),a.listings([]),$.ajax("results",{success:function(c){_.has(c,"region")&&(a.addListings(c.results),a.save("region",JSON.stringify(c.region)),a.save("listings",JSON.stringify(c.results)),a.save("searchFilter",a.filter()),a.updateFilterResults(),a.loading(!1),b.resolve(c))}}),b.promise},this.loadSavedData=function(){var b=!1;if("undefined"!=typeof Storage&&!_.isUndefined(localStorage.region)&&!_.isUndefined(localStorage.listings)){var c=JSON.parse(localStorage.region),d=JSON.parse(localStorage.listings),e=_.isString(localStorage.searchFilter)?localStorage.searchFilter:"";_.isObject(c)&&_.isObject(d)&&(a.initMap(c),a.addListings(d),a.filter(e),a.centerMap(c.center.latitude,c.center.longitude),b=!0)}return b},this.save=function(a,b){"undefined"!=typeof Storage&&localStorage.setItem(a,b)},this.setSizes=function(i){var j,k,l,m=b.height(),n=a.onSmallScreen(),o=d.height(),p=m-o,q=n?.35*p:p;n?(k=g.offsetHeight,l=k*(1+a.numVisibleListings()),q>l&&(q=l),j=m-q):j=0,c.css("height",p),f.css("height",q),_.isUndefined(i)||h||(f.niceScroll(),h=!0),e.css("top",j)},this.onSmallScreen=function(){return window.screen.width<SMALL_SCREEN_MAX_WIDTH},this.addListings=function(b){_.each(b,function(b){a.listings.push(new Listing(b))})},this.focusOnMarker=function(a){a.marker.openWindow()},this.initMap=function(a){var b={disableDefaultUI:!0};map=new google.maps.Map(document.querySelector("#map"),b)},this.updateFilterResults=function(){var b=a.filter().toLowerCase();a.save("searchFilter",a.filter()),_.each(a.listings(),function(a){var c=!1;inSearchFilter(a.title(),b)?c=!0:inSearchFilter(a.description(),b)?c=!0:inSearchFilter(a.phone(),b)&&(c=!0),a.toggle(c)}),a.setSizes()},this.numVisibleListings=function(){var b=0;return _.each(a.listings(),function(a){a.show()&&b++}),b},this.filter.subscribe(this.updateFilterResults),this.init()};